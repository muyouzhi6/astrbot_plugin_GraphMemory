# GraphMemory 插件设计总览

## 文档导航

本目录包含 GraphMemory 插件的核心设计文档:

1. **[06-人格与记忆设计.md](./06-人格与记忆设计.md)**: 人格切换时的记忆共享策略

## 一、设计背景

### 1.1 设计目标

1. **简化架构**: 减少概念层次，降低理解成本
2. **优化性能**: 异步并发，减少 LLM 调用
3. **提升可维护性**: 模块解耦，清晰的接口定义
4. **改善用户体验**: 减少配置项，智能默认值

## 二、核心改进

### 2.1 架构简化

| 方面 | 改进说明 |
|:---|:---|
| 记忆层次 | 2层 (缓冲区 + 图谱) |
| 配置项 | 18个核心配置 |
| Schema 节点 | 3种 (User, Session, Entity) |
| Schema 关系 | 4种 (PARTICIPATED_IN, RELATED_TO, MENTIONED_IN, KNOWS) |
| 人格策略 | 分层共享 |

### 2.2 新架构概览

```
用户消息 -> 缓冲区 -> 知识提取 -> 图数据库
                                      |
LLM 请求 -> 查询重写 -> 记忆检索 -> 注入 Prompt
            (可选)      (混合检索)
```

**记忆层次**:
- **短期记忆**: 缓冲区 (SQLite)
- **长期记忆**: 图谱 (KuzuDB)

### 2.3 简化的 Schema

**节点类型** (3种):
- `User`: 用户
- `Session`: 会话
- `Entity`: 实体 (人物/地点/事物/概念/事件)

**关系类型** (4种):
- `PARTICIPATED_IN`: User -> Session
- `RELATED_TO`: Entity -> Entity
- `MENTIONED_IN`: Entity -> Session
- `KNOWS`: User -> Entity

### 2.4 核心模块

1. **MemoryBuffer**: 消息缓冲管理
2. **KnowledgeExtractor**: 知识提取
3. **GraphStore**: 图数据库操作
4. **MemoryRetriever**: 记忆检索

## 三、关键特性

### 3.1 核心功能

1. **自动知识提取**: 从对话中提取实体和关系
2. **智能记忆检索**: 向量+关键词+图遍历混合检索
3. **被动记忆注入**: LLM 请求前自动注入相关记忆
4. **主动记忆检索**: Function Calling 工具 (新)

### 3.2 高级功能

1. **实体管理**: 消歧、合并、重要性计算
2. **关系管理**: 强度计算、证据保留
3. **时间感知**: 时间衰减、访问增强
4. **会话隔离**: 私聊/群聊分离、跨会话共享
5. **人格记忆**: 分层共享策略，用户信息共享，对话上下文隔离

### 3.3 管理功能

1. **指令系统**: stat/search/forget/export/import
2. **WebUI**: 图谱可视化、统计分析、实时监控

## 四、技术栈

### 4.1 后端

- **Python 3.10+**
- **KuzuDB**: 图数据库
- **SQLite**: 缓冲区存储
- **FastAPI**: WebUI 后端
- **AsyncIO**: 异步并发

### 4.2 前端

- **Vue 3**: 前端框架
- **TypeScript**: 类型安全
- **Element Plus**: UI 组件库
- **Cytoscape.js**: 图谱可视化
- **ECharts**: 统计图表
- **Vite**: 构建工具

## 五、开发计划

### 5.1 第一阶段: 核心功能 (2周)

- [ ] 简化 Schema 实现
- [ ] MemoryBuffer 模块
- [ ] KnowledgeExtractor 模块
- [ ] GraphStore 基础操作
- [ ] MemoryRetriever 基础检索
- [ ] 被动记忆注入
- [ ] 基础指令系统

**里程碑**: 实现基本的记忆存储和检索功能

### 5.2 第二阶段: 高级功能 (2周)

- [ ] 实体消歧和合并
- [ ] 关系强度计算
- [ ] 时间衰减机制
- [ ] 主动记忆检索 (Function Calling)
- [ ] 完整指令系统
- [ ] 性能优化

**里程碑**: 实现完整的记忆管理功能

### 5.3 第三阶段: WebUI (2周) ✅ 已完成

- [x] FastAPI 后端
- [x] Vue 3 前端框架搭建
- [x] 图谱可视化 (Cytoscape.js)
- [x] 实体/关系管理界面
- [x] 搜索测试界面 (混合/向量/关键词)
- [x] 统计分析界面 (ECharts 图表)
- [x] 系统管理 (导入/导出/清理)

**里程碑**: 完成可视化管理界面 ✅

### 5.4 第四阶段: 测试和优化 (1周) ✅ 已完成

- [x] 单元测试 (缓冲区、图数据库) - 13个测试
- [x] 集成测试 (WebUI API) - 10个测试
- [x] 性能测试 (图数据库、API) - 8个测试
- [x] 测试文档 (README、总结、检查清单)
- [x] 测试脚本 (run_tests.sh/bat)
- [x] 测试依赖配置

**里程碑**: 测试框架完成，31个自动化测试 ✅

## 六、配置项说明

### 6.1 当前配置项 (18项)

```json
{
    "embedding_provider_id": "必填，Embedding 模型",
    "llm_provider_id": "可选，知识提取模型",
    "enable_group_learning": "是否启用群聊学习",
    "buffer_size_private": "私聊缓冲区大小",
    "buffer_size_group": "群聊缓冲区大小",
    "buffer_timeout": "缓冲区超时时间",
    "enable_query_rewriting": "是否启用查询重写",
    "retrieval_top_k": "检索结果数量",
    "enable_function_calling": "是否启用主动检索",
    "webui_port": "WebUI 端口",
    "webui_key": "WebUI 访问密钥",
    "prune_interval": "图谱维护间隔",
    "time_decay_rate": "时间衰减率",
    "min_importance_threshold": "最小重要性阈值",
    "enable_entity_disambiguation": "是否启用实体消歧",
    "disambiguation_interval": "实体消歧间隔",
    "vector_search_weight": "向量检索权重",
    "keyword_search_weight": "关键词检索权重"
}
```

### 6.2 设计理念

- 采用分层共享策略，无需人格隔离配置
- 使用智能默认值，减少必填配置
- 保留必要的图谱维护和检索配置

## 七、性能优化

### 7.1 异步并发

```python
# 并发提取多个会话
tasks = [extractor.extract(conv, sid) for sid, conv in sessions]
results = await asyncio.gather(*tasks)

# 并发检索
vector_task = asyncio.create_task(vector_search(embedding))
keyword_task = asyncio.create_task(keyword_search(keywords))
results = await asyncio.gather(vector_task, keyword_task)
```

### 7.2 缓存策略

- LRU 缓存实体查询
- 缓存 Embedding 结果
- 缓存图谱布局

### 7.3 批量操作

- 批量插入实体
- 批量更新关系
- 事务处理

## 八、API 接口概览

### 8.1 图谱数据

- `GET /api/graph/session/{session_id}`: 获取会话图谱
- `GET /api/graph/global`: 获取全局图谱
- `GET /api/graph/neighbors/{entity_name}`: 获取实体邻居

### 8.2 实体管理

- `GET /api/entities`: 获取实体列表
- `GET /api/entities/{name}`: 获取单个实体
- `POST /api/entities`: 创建实体
- `PUT /api/entities/{name}`: 更新实体
- `DELETE /api/entities/{name}`: 删除实体
- `POST /api/entities/merge`: 合并实体

### 8.3 关系管理

- `GET /api/relations`: 获取关系列表
- `POST /api/relations`: 创建关系
- `PUT /api/relations`: 更新关系
- `DELETE /api/relations`: 删除关系

### 8.4 搜索功能

- `POST /api/search/hybrid`: 混合搜索
- `POST /api/search/vector`: 向量搜索
- `POST /api/search/keyword`: 关键词搜索

### 8.5 统计分析

- `GET /api/stats/overview`: 图谱统计
- `GET /api/stats/top-entities`: 实体排行
- `GET /api/stats/session-activity`: 会话活跃度
- `GET /api/stats/timeline`: 时间序列统计

### 8.6 系统管理

- `GET /api/system/export`: 导出图谱
- `POST /api/system/import`: 导入图谱
- `POST /api/system/cleanup`: 清理图谱
- `GET /api/system/status`: 系统状态

### 8.7 实时监控

- `WS /api/ws/monitor`: WebSocket 实时监控

## 九、前端页面

### 9.1 页面列表

1. **登录页** (`/login`): 输入访问密钥
2. **图谱视图** (`/graph`): 图谱可视化
3. **实体管理** (`/entities`): 实体列表和编辑
4. **关系管理** (`/relations`): 关系列表和编辑
5. **搜索测试** (`/search`): 搜索功能测试
6. **统计分析** (`/stats`): 图谱统计和分析
7. **系统管理** (`/system`): 导入导出、清理
8. **实时监控** (`/monitor`): 日志和任务监控

### 9.2 核心组件

- **GraphViewer**: 图谱可视化组件
- **EntityCard**: 实体卡片组件
- **RelationBadge**: 关系标签组件
- **SearchBar**: 搜索栏组件

## 十、迁移策略

### 10.1 数据迁移

旧版本 (v0.2.0) 数据不兼容，需要重新提取。

**原因**:
- Schema 完全重新设计
- 移除了 Message 和 MemoryFragment 节点
- 关系类型变化

**建议**:
- 导出旧版本数据 (JSON)
- 手动筛选重要实体和关系
- 导入到新版本

### 10.2 配置迁移

配置项大幅简化，需要手动迁移。

**映射关系**:
- `embedding_provider_id`: 保持不变
- `learning_model_id` -> `llm_provider_id`
- `enable_group_learning`: 保持不变
- 其他配置使用默认值

## 十一、风险和挑战

### 11.1 技术风险

1. **KuzuDB 性能**: 大规模图谱性能未知
   - **缓解**: 分页加载、节点聚合

2. **LLM 提取质量**: 依赖 LLM 能力
   - **缓解**: 增加验证机制、支持手动修正

3. **前端性能**: 大图谱渲染卡顿
   - **缓解**: 虚拟化渲染、节点聚合

### 11.2 开发风险

1. **时间估算**: 6周开发周期可能不足
   - **缓解**: 分阶段发布，优先核心功能

2. **测试覆盖**: 功能复杂，测试工作量大
   - **缓解**: 编写单元测试，自动化测试

### 11.3 用户风险

1. **数据迁移**: 旧版本数据不兼容
   - **缓解**: 提供迁移工具和文档

2. **学习成本**: 新界面需要适应
   - **缓解**: 提供用户手册和视频教程

## 十二、后续规划

### 12.1 v0.4.0 (未来)

- [ ] 多模态记忆 (图片、语音)
- [ ] 记忆推理 (传递关系、因果推断)
- [ ] 记忆共享 (跨用户、跨会话)
- [ ] 记忆导出 (Markdown、PDF)

### 12.2 v0.5.0 (未来)

- [ ] 分布式图数据库 (支持大规模部署)
- [ ] 记忆压缩 (自动归档旧记忆)
- [ ] 记忆安全 (加密、权限控制)
- [ ] 记忆分析 (情感分析、主题提取)

## 十三、总结

### 13.1 核心价值

1. **简化**: 从 3层记忆简化为 2层，配置项减少 50%
2. **高效**: 异步并发，减少 LLM 调用，提升性能
3. **智能**: 混合检索，时间衰减，主动检索
4. **可视化**: 完整的 WebUI，图谱可视化，统计分析

### 13.2 技术亮点

1. **Schema 设计**: 简洁高效，易于扩展
2. **混合检索**: 向量+关键词+图遍历
3. **时间感知**: 时间衰减和访问增强
4. **Function Calling**: LLM 主动检索记忆

### 13.3 预期效果

1. **用户体验**: 配置更简单，功能更强大
2. **性能**: 响应更快，资源消耗更低
3. **可维护性**: 代码更清晰，易于扩展
4. **可视化**: 直观的图谱管理界面

---

## 附录

### A. 术语表

- **实体 (Entity)**: 从对话中提取的人物、地点、事物、概念或事件
- **关系 (Relation)**: 实体之间的关联
- **重要性 (Importance)**: 实体的重要程度，基于访问频率和时间衰减
- **关系强度 (Strength)**: 关系的强弱程度，基于提及次数和时间
- **时间衰减 (Time Decay)**: 随时间降低旧记忆的重要性
- **访问增强 (Access Boost)**: 被访问的记忆重要性提升
- **混合检索 (Hybrid Search)**: 结合向量、关键词和图遍历的检索方式
- **Function Calling**: LLM 主动调用工具的能力

### B. 参考资料

- [AstrBot 文档](https://astrbot.app)
- [KuzuDB 文档](https://kuzudb.com)
- [Vue 3 文档](https://vuejs.org)
- [Cytoscape.js 文档](https://js.cytoscape.org)

### C. 联系方式

- **作者**: lxfight
- **项目**: astrbot_plugin_GraphMemory
- **版本**: v0.3.0 (设计中)

---

**文档版本**: 1.0
**最后更新**: 2025-01-XX
**状态**: 设计完成，待开发
