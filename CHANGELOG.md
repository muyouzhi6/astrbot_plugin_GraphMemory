# GraphMemory 变更日志

## [0.5.2] - 2025-12-19

### 优化改进
- **文档内容更新**
  - 修正配置项数量说明（18 个）
  - 更新文档导航和版本信息
  - 简化文档结构，提升可读性

#### 自动化工作流
- **自动发布工作流** (auto-release.yml)
  - 监听 `metadata.yaml` 版本号变化
  - 自动从 `CHANGELOG.md` 提取更新内容
  - 自动构建前端并创建 Release
  - 自动创建 Git tag 并上传打包文件
  - 支持多种 CHANGELOG 格式（`## [0.5.0]` 或 `## 0.5.0`）

- **工作流权限修复**
  - 修复 `release.yml` 权限问题
  - 添加 `permissions: contents: write`

- **工作流冲突修复**
  - 删除冲突的 `build-webui.yml`
  - 移除引用不存在 `resources/` 目录的打包逻辑
  - 统一发布流程

- **工作流文档**
  - 新增 `.github/WORKFLOWS.md` 使用说明
  - 详细说明三种工作流的用途和触发条件
  - 提供最佳实践和常见问题解答

### 修复问题
- 修复 auto-release.yml YAML 语法错误
  - 使用分组命令 `{...}` 代替 heredoc
  - 避免 YAML 解析器缩进问题

### 文档
- 新增自动化工作流使用指南
- 更新文档版本为 3.0
- 更新日期为 2025-12-19

### 技术改进
- 优化发布流程自动化程度
- 减少手动操作步骤
- 提升文档维护效率

---

## [0.5.0] - 2025-12-19

### 重大更新
完整的 WebUI 实现，图谱可视化管理界面全面上线。

### 新增功能

#### WebUI 可视化管理界面
- **图谱可视化** (Cytoscape.js)
  - 会话图谱和全局图谱切换
  - 节点大小表示实体重要性
  - 边宽度表示关系强度
  - 多种布局算法（力导向、环形、网格、同心圆）
  - 拖拽、缩放、节点搜索
  - 节点详情面板
  - 图例说明

- **实体管理界面**
  - 完整的 CRUD 操作
  - 列表、搜索、类型过滤
  - 重要性阈值过滤
  - 查看实体详情（名称、类型、描述、重要性、访问次数）
  - 编辑实体属性
  - 删除实体及关联关系
  - 分页浏览

- **关系管理界面**
  - 关系列表展示
  - 起点/终点实体过滤
  - 关系强度过滤
  - 查看关系详情（起点、关系类型、终点、强度、证据）
  - 删除关系
  - 分页浏览

- **搜索测试界面**
  - 三种搜索模式：混合搜索、向量搜索、关键词搜索
  - 可配置 Top K 结果数量
  - 实时搜索结果展示
  - 显示实体详情和关系

- **统计分析界面**
  - 概览卡片（实体数、关系数、会话数、用户数）
  - 实体类型分布饼图 (ECharts)
  - 实体创建趋势折线图 (ECharts)
  - 图表支持明暗主题自动适配
  - 响应式布局

- **系统管理界面**
  - 系统状态查看（版本、Provider、统计信息）
  - 图谱导出为 JSON（支持人格过滤）
  - 图谱导入（支持合并/覆盖模式）
  - 清理低重要性实体（可配置阈值）
  - 应用时间衰减（可配置衰减率）
  - 操作日志记录

- **主题切换**
  - 明暗主题支持
  - 主题设置持久化
  - 所有图表自动适配主题

#### WebUI 后端 (FastAPI)
- **RESTful API 接口**
  - 图谱数据接口（会话/全局图谱）
  - 实体管理接口（增删改查）
  - 关系管理接口（查询、删除）
  - 搜索接口（混合/向量/关键词）
  - 统计分析接口
  - 系统管理接口（导入/导出/清理）

- **安全认证**
  - 访问密钥认证
  - 支持 Query 参数和 Header 认证
  - 可配置密钥或自动生成

- **性能优化**
  - 异步处理
  - 分页加载
  - CORS 支持

#### 自动化工作流
- **自动发布工作流** (auto-release.yml)
  - 监听 `metadata.yaml` 版本号变化
  - 自动检测版本更新
  - 从 `CHANGELOG.md` 提取更新内容
  - 自动构建前端
  - 创建 Git tag
  - 创建 GitHub Release
  - 上传打包文件

- **权限修复**
  - 修复 release.yml 权限问题
  - 添加 `contents: write` 权限

### 优化改进

#### 图谱可视化优化
- **莫兰迪配色方案**
  - 人物：#7EC8E3（天蓝）
  - 地点：#9BD49C（草绿）
  - 事物：#F4C87F（杏黄）
  - 概念：#D4A5D4（浅紫）
  - 事件：#F5A9A3（珊瑚粉）
  - 柔和低饱和度，视觉舒适

- **节点样式优化**
  - 移除节点图标，使用纯色填充
  - 移除文字描边和背景
  - 增加节点背景不透明度（普通 0.6、悬停 0.75、选中 0.85）
  - 保留节点阴影效果

- **布局算法优化**
  - 使用 fcose 替代 cose 布局
  - 优化节点间距和引力参数
  - 修复重复配置项

#### 文档整理
- **删除过时文档** (6个)
  - `01-现有功能分析.md` - v0.2.0 分析，已过时
  - `02-AstrBot接口分析.md` - 开发阶段文档
  - `03-新架构设计.md` - 开发阶段文档
  - `04-接口设计.md` - 开发阶段文档
  - `05-前端设计.md` - 开发阶段文档
  - `更新说明.md` - 与 CHANGELOG.md 重复

- **更新核心文档**
  - `docs/README.md` - 更新文档导航和版本信息
  - `docs/00-设计总览.md` - 修正配置项数量为 18 个
  - 简化文档结构，保留核心文档

- **新增工作流文档**
  - `.github/WORKFLOWS.md` - 工作流使用说明

### 技术栈

#### 前端
- Vue 3 (Composition API)
- TypeScript
- Vite
- Cytoscape.js (图谱可视化)
- ECharts (统计图表)
- Axios (HTTP 客户端)
- Lucide Vue (图标库)

#### 后端
- FastAPI (WebUI 后端)
- Uvicorn (ASGI 服务器)
- Pydantic (数据验证)

### 配置更新
- 总配置项：18 个（无变化）
- WebUI 相关配置：
  - `webui_port`: WebUI 访问端口（默认 8081）
  - `webui_key`: WebUI 访问密钥

### 测试

#### 测试覆盖
- 单元测试：13 个
- 集成测试：10 个（WebUI API）
- 性能测试：8 个
- 总计：31 个自动化测试

#### 测试框架
- pytest
- pytest-asyncio
- pytest-cov (代码覆盖率)

### 构建和部署

#### 前端构建
- 构建脚本：`scripts/build.sh` (Linux/macOS)
- 构建脚本：`scripts/build.bat` (Windows)
- 构建产物：`webui/static/`

#### 发布打包
- 自动排除开发文件
- 支持 `.tar.gz` 和 `.zip` 格式
- 前端已预构建，用户直接使用

### 文档
- WebUI 使用指南
- 工作流使用说明
- 文档结构优化

### 已知问题
- 无

### 升级说明
从 v0.4.0 升级：
1. 更新插件文件
2. 配置 `webui_port` 和 `webui_key`（可选）
3. 访问 `http://localhost:8081` 进入 WebUI

---

## [0.4.0] - 2025-12-18

### 新增功能

#### 管理指令
- **`/memory_search`** - 搜索图谱中的实体
  - 支持关键词搜索
  - 支持实体类型过滤
  - 支持结果数量限制
  - 显示实体的描述、重要性、访问次数和关系

- **`/memory_forget`** - 删除指定的实体
  - 需要 `confirm:yes` 参数确认删除
  - 自动删除相关的所有关系
  - 显示删除的关系数量

- **`/memory_export`** - 导出图谱数据为 JSON 格式
  - 支持导出所有数据或指定人格的数据
  - 导出实体、关系和会话信息
  - 自动保存到插件数据目录

- **`/memory_import`** - 从 JSON 文件导入图谱数据
  - 支持合并模式和覆盖模式
  - 显示导入的实体和关系数量
  - 自动处理数据冲突

#### 主动记忆检索（Function Calling）
- **`search_memory` 工具** - LLM 可主动调用的记忆检索工具
  - 支持关键词、类型过滤和结果数量限制
  - 返回实体及其关系的 JSON 格式数据
  - 需要 LLM 支持 Function Calling
  - 通过配置 `enable_function_calling` 启用

#### 实体消歧和合并
- **自动识别相似实体** - 基于向量相似度
  - 可配置相似度阈值（默认 0.85）
  - 只比较相同类型的实体
  - 按重要性优先处理

- **智能合并实体** - 使用 LLM 判断
  - 合并实体的重要性和访问次数
  - 转移所有关系到保留的实体
  - 自动处理关系冲突和合并

- **定期自动消歧** - 集成到维护循环
  - 可配置消歧间隔（默认 7200 秒）
  - 通过配置 `enable_entity_disambiguation` 启用
  - 记录消歧结果和统计信息

- **`/memory_disambiguate`** - 手动触发实体消歧
  - 支持自定义相似度阈值（`threshold:<0-1>`）
  - 支持自动合并模式（`auto_merge:true|false`）
  - 显示找到的相似实体对和合并结果
  - 默认使用 LLM 判断是否合并

#### 检索算法优化
- **加权混合检索** - 可配置向量和关键词权重
  - 向量检索权重：默认 0.7
  - 关键词检索权重：默认 0.3
  - 同时命中两种检索的实体额外加分 20%

- **智能重排序** - 综合多个因素
  - 检索分数权重：60%
  - 实体重要性权重：30%
  - 访问频率权重：10%
  - 考虑时间衰减（通过 importance 体现）

- **可配置权重** - 新增配置项
  - `vector_search_weight`: 向量检索权重
  - `keyword_search_weight`: 关键词检索权重

### 核心功能
- 在 `GraphStore` 中添加了搜索、删除、导出、导入方法
- 创建了 `FunctionCallingHandler` 处理 Function Calling
- 创建了 `EntityDisambiguation` 处理实体消歧
- 创建了 `CommandHandler` 分离指令处理逻辑
- 优化了 `MemoryRetriever` 的检索和排序算法

### 改进
- **代码架构优化** - 分离关注点
  - `main.py` 只负责注册，不包含业务逻辑
  - `command_handler.py` 处理所有指令逻辑
  - 提高代码可维护性和可测试性

- 完善了关系信息的格式化输出
- 改进了错误处理和日志记录
- 优化了代码结构和注释

### 配置更新
新增 4 个配置项：
- `enable_entity_disambiguation`: 启用实体消歧（默认 false）
- `disambiguation_interval`: 实体消歧间隔（默认 7200 秒）
- `vector_search_weight`: 向量检索权重（默认 0.7）
- `keyword_search_weight`: 关键词检索权重（默认 0.3）

### 文档
- 创建了 v0.4.0 开发计划文档
- 更新了版本号和描述
- 更新了 CHANGELOG.md

---

## [0.3.1] - 2025-12-18

### 修复
- **修复嵌套事件循环问题** (`graph_store.py:147-149`)
  - 将 `asyncio.run()` 改为在异步上下文中直接 `await`
  - 避免了 "RuntimeError: This event loop is already running" 错误

### 改进
- **完善记忆检索器的关系信息格式化**
  - 实现了 `_get_relations_between_entities()` 方法
  - 在记忆上下文中显示实体间的关系

- **优化 Prompt 模板**
  - 知识提取 Prompt 更加详细和结构化
  - 查询重写 Prompt 添加了示例和规则说明

### 文档
- 创建了详细的测试计划文档
- 更新了版本号到 0.3.0

---

## [0.3.0] - 2025-12-18

### 重大更新
完全重新设计和实现的版本，采用全新的简化架构。

### 新架构
- **2层记忆系统**
  - 缓冲区（MemoryBuffer）：短期记忆
  - 图谱（GraphStore）：长期记忆

- **简化的 Schema**
  - 3种节点类型：User, Session, Entity
  - 4种关系类型：PARTICIPATED_IN, RELATED_TO, MENTIONED_IN, KNOWS

### 核心功能
- **自动知识提取**
  - 从对话中提取实体和关系
  - 支持增量更新
  - 实体重要性计算

- **智能记忆检索**
  - 向量 + 关键词混合检索
  - 人格过滤（分层共享策略）
  - 结果排序和格式化

- **被动记忆注入**
  - LLM 请求前自动注入
  - 查询重写提升准确性
  - 格式化输出

- **人格分层共享**
  - 自动获取当前人格ID
  - 人格切换检测
  - 检索时过滤当前人格相关记忆

- **时间衰减机制**
  - 定期衰减实体重要性和关系强度
  - 清理低重要性实体
  - 访问时增强重要性

### 核心模块
- `core/schema.py` - Schema 定义
- `core/entities.py` - 数据实体
- `core/prompts.py` - Prompt 模板
- `core/memory_buffer.py` - 消息缓冲
- `core/knowledge_extractor.py` - 知识提取
- `core/graph_store.py` - 图数据库
- `core/memory_retriever.py` - 记忆检索
- `core/manager.py` - 核心管理器

### 配置
- 14 个配置项（简化 30%）
- 支持私聊/群聊分别配置缓冲区大小
- 支持查询重写、时间衰减等高级功能

### 指令
- `/memory_stat` - 显示图谱统计信息

---

## [0.2.1] - 之前版本

旧版本，已废弃。

---

**版本格式**: [主版本.次版本.修订版本]
**日期格式**: YYYY-MM-DD
