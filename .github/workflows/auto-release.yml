name: Auto Release

on:
  push:
    branches:
      - main
    paths:
      - 'metadata.yaml'

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.version_check.outputs.should_release }}
      new_version: ${{ steps.version_check.outputs.new_version }}
      release_notes: ${{ steps.extract_notes.outputs.notes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check version change
        id: version_check
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬
          NEW_VERSION=$(grep '^version:' metadata.yaml | awk '{print $2}')
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # è·å–ä¸Šä¸€æ¬¡æäº¤çš„ç‰ˆæœ¬
          git checkout HEAD~1 metadata.yaml 2>/dev/null || true
          OLD_VERSION=$(grep '^version:' metadata.yaml | awk '{print $2}' 2>/dev/null || echo "0.0.0")
          git checkout HEAD metadata.yaml

          echo "å½“å‰ç‰ˆæœ¬: $NEW_VERSION"
          echo "æ—§ç‰ˆæœ¬: $OLD_VERSION"

          # æ¯”è¾ƒç‰ˆæœ¬å·ï¼ˆç®€å•å­—ç¬¦ä¸²æ¯”è¾ƒï¼‰
          if [ "$NEW_VERSION" != "$OLD_VERSION" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°: $OLD_VERSION -> $NEW_VERSION"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  ç‰ˆæœ¬å·æœªå˜åŒ–ï¼Œè·³è¿‡å‘å¸ƒ"
          fi

      - name: Extract changelog
        id: extract_notes
        if: steps.version_check.outputs.should_release == 'true'
        run: |
          NEW_VERSION="${{ steps.version_check.outputs.new_version }}"

          # ä» CHANGELOG.md æå–å¯¹åº”ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
          if [ -f "CHANGELOG.md" ]; then
            # æå–ä» [NEW_VERSION] åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡é¢˜ä¹‹é—´çš„å†…å®¹
            NOTES=$(awk "/## \[$NEW_VERSION\]/,/## \[.*\]/{if(/## \[.*\]/ && !/## \[$NEW_VERSION\]/)exit;print}" CHANGELOG.md | tail -n +2)

            # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•ä¸å¸¦æ–¹æ‹¬å·çš„æ ¼å¼
            if [ -z "$NOTES" ]; then
              NOTES=$(awk "/## $NEW_VERSION/,/## /{if(/## / && !/## $NEW_VERSION/)exit;print}" CHANGELOG.md | tail -n +2)
            fi

            # å¦‚æœè¿˜æ˜¯ç©ºçš„ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
            if [ -z "$NOTES" ]; then
              NOTES="ç‰ˆæœ¬ $NEW_VERSION å·²å‘å¸ƒã€‚è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)ã€‚"
            fi
          else
            NOTES="ç‰ˆæœ¬ $NEW_VERSION å·²å‘å¸ƒã€‚"
          fi

          # æ·»åŠ è‡ªåŠ¨ç”Ÿæˆæ ‡è®°å¹¶ä¿å­˜åˆ°æ–‡ä»¶
          {
            echo "$NOTES"
            echo ""
            echo "---"
            echo ""
            echo "ğŸ¤– æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ"
            echo "ğŸ“… å‘å¸ƒæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸ“¦ æ„å»ºåˆ†æ”¯: ${{ github.ref_name }}"
            echo "ğŸ”— æäº¤: ${{ github.sha }}"
          } > /tmp/release_notes.md

          # è¾“å‡ºåˆ° GITHUB_OUTPUTï¼ˆä½¿ç”¨ heredocï¼‰
          {
            echo 'notes<<EOF'
            cat /tmp/release_notes.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "âœ… æå–åˆ°æ›´æ–°æ—¥å¿—"

  create-release:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webui-src/package-lock.json

      - name: Install dependencies
        working-directory: webui-src
        run: npm ci

      - name: Build frontend
        working-directory: webui-src
        run: npm run build

      - name: Check build output
        run: |
          echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
          ls -lh webui/static/
          echo ""
          echo "ğŸ“„ èµ„æºæ–‡ä»¶:"
          ls -lh webui/static/assets/ | head -10

      - name: Create release archive
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release

          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼ˆæ’é™¤ä¸éœ€è¦çš„ï¼‰
          rsync -av --progress . release/astrbot_plugin_GraphMemory \
            --exclude .git \
            --exclude .github \
            --exclude webui-src/node_modules \
            --exclude webui-src/dist \
            --exclude __pycache__ \
            --exclude '*.pyc' \
            --exclude data \
            --exclude .vscode \
            --exclude .idea \
            --exclude release \
            --exclude tests \
            --exclude .pytest_cache \
            --exclude htmlcov \
            --exclude .coverage

          # æ‰“åŒ…
          cd release
          tar -czf astrbot_plugin_GraphMemory.tar.gz astrbot_plugin_GraphMemory
          zip -r astrbot_plugin_GraphMemory.zip astrbot_plugin_GraphMemory

          echo "âœ… æ‰“åŒ…å®Œæˆ:"
          ls -lh *.tar.gz *.zip

      - name: Create Git tag
        run: |
          VERSION="v${{ needs.check-version.outputs.new_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"
          echo "âœ… åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾: $VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version.outputs.new_version }}
          name: v${{ needs.check-version.outputs.new_version }}
          body: ${{ needs.check-version.outputs.release_notes }}
          draft: false
          prerelease: false
          files: |
            release/astrbot_plugin_GraphMemory.tar.gz
            release/astrbot_plugin_GraphMemory.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-v${{ needs.check-version.outputs.new_version }}
          path: release/
          retention-days: 90
